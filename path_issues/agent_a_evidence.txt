# AGENT A - RISK LEDGER SYNC FIX - EVIDENCE

## Date: 2025-10-09 18:48:02 UTC
## Branch: chore/fix-risk-ledger-sync

## FILES MODIFIED (with evidence)

### 1. BotG/Telemetry/RiskSnapshotPersister.cs
**Line 25**: Updated header to include open_pnl and closed_pnl
   OLD: "timestamp,equity,balance,margin,free_margin,drawdown,R_used,exposure"
   NEW: "timestamp_utc,equity,balance,open_pnl,closed_pnl,margin,free_margin,drawdown,R_used,exposure"

**Lines 13-14**: Added _closedPnl field for cumulative tracking
   `csharp
   private double _closedPnl = 0.0;
   `

**Lines 31-38**: Added AddClosedPnl() method for trade close tracking
   `csharp
   public void AddClosedPnl(double pnl)
   {
       lock (_lock) { _closedPnl += pnl; }
   }
   `

**Lines 50-52**: Implemented open_pnl calculation (equity - balance)
   `csharp
   double openPnl = equity - balance;
   `

**Lines 54-59**: Added closed_pnl retrieval with thread safety
   `csharp
   double closedPnl;
   lock (_lock) { closedPnl = _closedPnl; }
   `

**RESULT**: equity = balance + open_pnl synchronization verified by formula

### 2. BotG/Telemetry/ClosedTradesWriter.cs
**Lines 45-46**: Wired closed_pnl tracking on every trade close
   `csharp
   // Update cumulative closed P&L in risk snapshot persister
   TelemetryContext.RiskPersister?.AddClosedPnl(pnlAccountCcy);
   `

**RESULT**: Every trade close now updates the cumulative closed_pnl

### 3. BotG/Execution/ExecutionModule.cs
**Lines 186-188**: REMOVED sizing fallback, added fail-fast
   OLD: requestedUnits = 1000; // fallback to legacy default
   NEW: throw new InvalidOperationException("Risk sizing calculation failed - cannot proceed with order");

**Lines 192-193**: REMOVED legacy default sizing, added fail-fast
   OLD: requestedUnits = 1000; // legacy default
   NEW: throw new InvalidOperationException("RiskManager not initialized - cannot proceed with order");

**RESULT**: No more fallback sizing - RiskManager.CalculateOrderSize is sole source

### 4. config.runtime.json
**Added explicit Gate2 config**:
   - simulation.enabled: false
   - SecondsPerHour: 3600
   - hours: 24

**RESULT**: Eliminates runtime ambiguity, explicit paper mode declaration

### 5. path_issues/start_24h_command_ready.txt
**Updated for production**:
   OLD: hours=0.25
   NEW: hours=24

## VERIFICATION PLAN

1. **Build Check**: Compile solution (0 errors expected)
2. **Smoke Test**: Run 15min test (hours=0.25) to validate ledger sync
3. **Evidence**: Check risk_snapshots.csv for:
   - open_pnl != 0 (when positions open)
   - closed_pnl increases on trade close
   - equity = balance + open_pnl at all times

## EXPECTED BEHAVIOR

**Before Fix**:
- risk_snapshots.csv: open_pnl always 0.0, closed_pnl always 0.0
- ExecutionModule: Fallback to 1000 units if risk sizing fails

**After Fix**:
- risk_snapshots.csv: open_pnl = equity - balance, closed_pnl cumulative
- ExecutionModule: Throws exception if risk sizing fails (fail-fast)
- config.runtime.json: Explicit paper mode configuration

## COMMIT MESSAGE
fix(risk): sync equity/closed_pnl with FIFO; implement open_pnl aggregation; remove sizing fallback

## NEXT STEPS
1. Commit changes
2. Run smoke test (15 min)
3. Verify risk_snapshots.csv has proper open_pnl/closed_pnl values
4. Create PR with this evidence
