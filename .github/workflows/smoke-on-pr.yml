name: smoke-fast-on-pr
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop, feat/** ]
  push:
    branches: [ ci/** ]

concurrency:
  group: workflow-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  shadow:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      status:   ${{ steps.decide.outputs.status }}
      reason:   ${{ steps.decide.outputs.reason }}
      retry_ok: ${{ steps.decide.outputs.retry_ok }}
    steps:
      - name: Runner & concurrency guard
        shell: bash
        run: |
          echo "=== Runner & Concurrency Diagnostics ==="
          echo "Runner name: ${{ runner.name }}"
          echo "Runner OS: ${{ runner.os }}"
          echo "Runner arch: ${{ runner.arch }}"
          echo "Runner temp: ${{ runner.temp }}"
          echo "Runner tool cache: ${{ runner.tool_cache }}"
          echo "---"
          echo "Job ID: ${{ github.job }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run number: ${{ github.run_number }}"
          echo "Run attempt: ${{ github.run_attempt }}"
          echo "---"
          echo "Workflow: ${{ github.workflow }}"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "---"
          echo "Concurrency group: workflow-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
          echo "Cancel-in-progress: true"
          echo "---"
          echo "Environment: ${{ github.environment }}"
          echo "Job started: $(date -u +%FT%TZ)"
          echo "========================================"

      - uses: actions/checkout@v4

      - name: Start event
        run: |
          mkdir -p .botg
          echo '{"ts":"'"$(date -u +%FT%TZ)"'","run_id":'${{ github.run_id }}',"pr":'${{ github.event.pull_request.number || 0 }}',"stage":"shadow","level":"info","msg":"start","kv":{"sha":"${{ github.sha }}","actor":"${{ github.actor }}","runner":"${{ runner.name }}"}}' >> .botg/events.jsonl

      - name: Run shadow tests (fast)
        id: tests
        shell: bash
        run: |
          set -e
          echo "TODO: Implement shadow tests"
          echo '{"status":"PASS","reason":"not_implemented"}' > .botg/status.json

      - name: Classify results
        if: always()
        id: classify
        shell: bash
        run: |
          set -e
          cat .botg/status.json

      - name: Decide & log
        if: always()
        id: decide
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          STATUS=$(jq -r .status < .botg/status.json)
          REASON=$(jq -r .reason < .botg/status.json)
          RETRY_OK="false"

          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT
          echo "retry_ok=$RETRY_OK" >> $GITHUB_OUTPUT
          echo '{"ts":"'"$(date -u +%FT%TZ)"'","run_id":'${{ github.run_id }}',"pr":'${{ github.event.pull_request.number || 0 }}',"stage":"decide","level":"info","msg":"conclusion","kv":{"status":"'"$STATUS"'","reason":"'"$REASON"'"}}' >> .botg/events.jsonl

      - name: Upload events
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-events-${{ github.run_id }}
          path: .botg/events.jsonl
          retention-days: 7

  auto-rerun:
    needs: shadow
    if: needs.shadow.outputs.status == 'AUTO_RERUN' && needs.shadow.outputs.retry_ok == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Log auto-rerun
        run: echo "Auto-rerun triggered"
