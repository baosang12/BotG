name: CI — build & test

on:
  push:
    branches:
      - main
      - 'botg/**'
  pull_request:
    branches:
      - main

jobs:
  build-test:
    name: Build and Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
<<<<<<< HEAD
        # Temporarily restrict to Windows while Linux vstest is investigated
        os: [windows-latest]
=======
        # Pin to ubuntu-22.04 because .NET 6 runtime isn't available on ubuntu-24.04 runners
        os: [ubuntu-22.04, windows-latest]
>>>>>>> origin/main
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET SDKs (6.x and 9.x)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            6.0.x
            9.0.x

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          name: CI — build & test

          on:
            workflow_dispatch:
            push:
              branches:
                - main
                - 'botg/**'
            pull_request:
              branches:
                - main

          jobs:
            build-test:
              name: Build and Test (${{ matrix.os }})
              runs-on: ${{ matrix.os }}
              strategy:
                matrix:
                  # Temporarily restrict to Windows while Linux vstest is investigated
                  os: [windows-latest]
              steps:
                - name: Checkout repo
                  uses: actions/checkout@v4
                  with:
                    fetch-depth: 0

                - name: Setup .NET SDKs (6.x and 9.x)
                  uses: actions/setup-dotnet@v4
                  with:
                    dotnet-version: |
                      6.0.x
                      9.0.x

                - name: Cache NuGet packages
                  uses: actions/cache@v4
                  with:
                    path: ~/.nuget/packages
                    key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
                    restore-keys: |
                      nuget-${{ runner.os }}-

                - name: Restore
                  run: dotnet restore

                - name: Build
                  run: dotnet build --no-restore --configuration Debug

                - name: Show installed runtimes
                  run: |
                    dotnet --info
                    dotnet --list-runtimes

                - name: Test
                  run: dotnet test --configuration Debug --verbosity normal --results-directory ./test-results

                - name: Upload test results (optional)
                  if: always()
                  uses: actions/upload-artifact@v4
                  with:
                    name: test-results-${{ matrix.os }}
                    path: ./test-results
